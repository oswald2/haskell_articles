%% Buchvorlage unter Verwendung der Book-Klasse des KOMA-Script      %%
%% Basierend auf einer TeXNicCenter-Vorlage von Mark Müller          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Wählen Sie die Optionen aus, indem Sie % vor der Option entfernen  
% Dokumentation des KOMA-Script-Packets: scrguide

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Optionen zum Layout des Buchs                                     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[
%a5paper,							% alle weiteren Papierformat einstellbar
%landscape,						% Querformat
12pt,								% Schriftgröße (12pt, 11pt (Standard))
%BCOR1cm,							% Bindekorrektur, bspw. 1 cm
%DIVcalc,							% führt die Satzspiegelberechnung neu aus
%											  s. scrguide 2.4
%oneside,							% einseitiges Layout
%twocolumn,						% zweispaltiger Satz
%openany,							% Kapitel können auch auf linken Seiten beginnen
%halfparskip*,				% Absatzformatierung s. scrguide 3.1
%headsepline,					% Trennline zum Seitenkopf	
%footsepline,					% Trennline zum Seitenfuß
%notitlepage,					% in-page-Titel, keine eigene Titelseite
%chapterprefix,				% vor Kapitelüberschrift wird "Kapitel Nummer" gesetzt
%appendixprefix,				% Anhang wird "Anhang" vor die Überschrift gesetzt 
%normalheadings,			% Überschriften etwas kleiner (smallheadings)
idxtotoc,						% Index im Inhaltsverzeichnis
liststotoc,					% Abb.- und Tab.verzeichnis im Inhalt
bibtotoc,						% Literaturverzeichnis im Inhalt
%leqno,								% Nummerierung von Gleichungen links
%fleqn,								% Ausgabe von Gleichungen linksbündig
%draft								% überlangen Zeilen in Ausgabe gekennzeichnet
]
{scrbook}

%\pagestyle{empty}		% keine Kopf und Fußzeile (k. Seitenzahl)
%\pagestyle{headings}	% lebender Kolumnentitel  

%% Fonts für pdfLaTeX, falls keine cm-super-Fonts installiert%%%%%%%%%

%% Packages für Grafiken & Abbildungen %%%%%%%%%%%%%%%%%%%%%%
\usepackage[pdftex]{graphicx} %%Grafiken in pdfLaTeX



%% optischer Randausgleich, falls pdflatex verwandt %%%%%%%%%%%%%%%%%%%
\usepackage[activate]{pdfcprot}				

\usepackage[dvipsnames]{xcolor}


\usepackage[T1]{fontenc}   % T1-Kodierung des Zeichensatzes
\usepackage[utf8]{inputenc} % Eingabekodierung (Linux)
\usepackage{
  ,soul         % Sperren, Unterstreichen, Durchstreichen ...
  ,array        % Erweiterungen für Tabellen
  ,booktabs     %       "        "      "
  ,supertabular % Mehrseitige Tabellen
  ,longtable    %      "          "    
  ,colortbl     % Farben in Tabellenzellen
  ,tabularx
  ,textcomp     % Zusätzliche (Sonder)Zeichen
  ,natbib       % Formatierung der Zitate
  ,calc         % Rechnen mit LaTeX-Längen und -Zählern
  ,url          % URLs setzen
  ,tocloft      % Verzeichnisse (TOC, LOF, LOT) formatieren
  ,graphicx     % Grafiken einbinden
  ,paralist     % Zusätzliche Listen-Umgebungen
  ,multicol     % Mehrspaltensatz
  ,ragged2e     % Bessere Trennung bei Flattersatz
  ,pst-3d       % Für das Beispiel der verschrägten Aufrechten
  ,pst-pdf      % PostScript-Code mit pdflatex verwenden
  ,fixltx2e     % Korrigiert Fehler und erweitert LaTeX2e
  ,cmap         % verbessert das Kopieren aus PDF-Anzeigeprogrammen und
                % das Durchsuchen von PDF-Dateien 
  ,makeidx      % Index-Erzeugung
}



\usepackage{textcomp}
\usepackage{lmodern}
\usepackage[sc, osf]{mathpazo}
\usepackage{amsmath}

%% deutsche Anpassung %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[english]{babel}		
\usepackage{multirow,bigdelim} 
\usepackage[paper=a4paper,left=25mm,right=25mm,top=20mm,bottom=28mm]{geometry} 
\usepackage{niceframe}
\usepackage[english]{varioref}      % »Intelligente« Querverweise
\usepackage{tabulary}

\usepackage{wrapfig}
\usepackage{ amssymb }

% Neue Option »C« für longtable, um Tabellen > \textwidth auf der Seite
% zu zentrieren (Heiko Oberdiek in <d892mm$9nq$1@news.BelWue.DE>) unter
% Berücksichtigung des im Rand zur Verfügung stehenden Freiraums (Markus
% Kohm in <1780717.PVTQaRvHTA@mjk.komascript.de>). 
\makeatletter
\let\ORG@LT@array\LT@array
\def\LT@array[#1]{%
  \if C#1%
    \setlength{\@tempdima}{\oddsidemargin}
    \addtolength{\@tempdima}{1in}
    \LTleft=0pt plus 1fill minus \@tempdima
    \LTright=\LTleft
    \expandafter\ORG@LT@array\expandafter[\expandafter x\expandafter]%
  \else
    \@ReturnAfterFi{%
      \ORG@LT@array[{#1}]%
    }%
  \fi
}
\long\def\@ReturnAfterFi#1\fi{\fi#1}
\makeatother



% um Tabellenspalten mit Flattersatz zu setzen, muss \\ vor
% (z.B.) \raggedright geschützt werden:
\newcommand{\PreserveBackslash}[1]{\let\temp=\\#1\let\\=\temp}
%
% Spalten mit Flattersatz:
% Linksbündig:\chapter{Massage}
\newcolumntype{L}[1]{>{\PreserveBackslash\RaggedRight}m{#1}}
\newcolumntype{M}[1]{>{\PreserveBackslash\RaggedRight}p{#1}}
% Rechtsbündig (nicht verwendet im Dokument):
\newcolumntype{R}[1]{>{\PreserveBackslash\RaggedLeft}m{#1}}
\newcolumntype{S}[1]{>{\PreserveBackslash\RaggedLeft}p{#1}}
% Zentriert (nicht verwendet im Dokument):
\newcolumntype{Z}[1]{>{\PreserveBackslash\Centering}m{#1}}
\newcolumntype{A}[1]{>{\PreserveBackslash\Centering}p{#1}}

% Tabellen mit grauem Header und grauer hline am Ende und entsprechend
% eingestellten Schriften (in diesem Fall nur fett); Verwendung über
% \hdrow (s.u.)
%
% Linksbündig:
\newcolumntype{H}{>{\fontseries{b}\selectfont%
    \columncolor[gray]{.8}[6pt][0pt]}l}
% Zentriert (nicht verwendet im Dokument):
\newcolumntype{I}{>{\fontseries{b}\selectfont%
    \columncolor[gray]{.8}[6pt][0pt]}c}
% Rechtsbündig (nicht verwendet im Dokument):
\newcolumntype{J}{>{\fontseries{b}\selectfont%
    \columncolor[gray]{.8}[6pt][0pt]}r}
%
\newcommand{\hdrow}[2]{%
  \multicolumn{1}{#1@{}}{%
    \raisebox{.1mm}{% Ausrichtung der Beschriftung
      #2%
    }\rule{0pt}{4mm}}% unsichtbare Linie, die die Kopfzeile höher macht
} 

% Alternative ohne \multicolumn und \columncolor, direkt über \rowcolor:
%\newcommand{\Hdrow}[1]{\rowcolor[gray]{.8}#1 \\\addlinespace}\chapter{Massage}
\newenvironment{tabelle}[2][c]{%
  \renewcommand{\arraystretch}{1.2} % Größere Abstände zwischen Zeilen
  \sffamily\small                   % Serifenlose und kleine Schrift
  \begin{longtable}[#1]{#2}
  }
  {\end{longtable}\renewcommand{\arraystretch}{1}% Abstände wieder
                                                 % zurücksetzen 
  \normalsize\rmfamily % Schrift wieder zurücksetzen
  }

% Auch »Abbildung« und nicht nur die Nummer wird zum Link (abgeleitet
% aus Posting von Heiko Oberdiek (d09n5p$9md$1@news.BelWue.DE);
% Verwendung: In \abbvref{label} ist ein Beispiel dargestellt
\providecommand*{\abbvrefname}{Abbildung}
\newcommand*{\abbvref}[1]{%
  \hyperref[#1]{\abbvrefname}\vref{#1}%
}



\usepackage[%
  breaklinks               % Links »überstehen« Zeilenumbruch
  ,backref                 % Backlinks im Literaturverzeichnis
  ,colorlinks              % Links erhalten Farben statt Kästen
  ,citecolor=myblue        % Farbe für Zitate
  ,linkcolor=myblue        % beeinflusst Inhaltsverzeichnis und Seitenzahlen
  ,urlcolor=myblue         % Farbe für URLs
  ,bookmarks               % Erzeugung von Bookmarks für PDF-Viewer
  ,bookmarksnumbered       % Nummerierung der Bookmarks
  ,hyperfootnotes=false    % Keine Links auf Fußnoten
  ,pdfpagelabels 
  ,pdftex
  ,pdftitle={Haskell Articles}
  ,pdfsubject={A List of Haskell Articles on good design, good testing}
  ,pdfauthor={Michael Oswald}
  ,pdfcreator={LaTeX, hyperref, KOMA-Script}
  ,pdfstartview=FitH,      % Dokument wird »Fit Width« geöffnet
  ,pdfpagemode=UseOutlines % Bookmarks im Viewer anzeigen
  ,pdfdisplaydoctitle=true
  ,bookmarksopenlevel=2    % Gliederungstiefe der Bookmarks
  ] 
  {hyperref}               % PDF automatisch mit Links versehen und weitere
                           % Hypertext-Funktionalität ermöglichen
% Farbdefinitionen:
\definecolor{myblue}{rgb}{0,.1,.6}
\definecolor{myblue2}{rgb}{0,.4,.6}
\definecolor{grau}{gray}{.4}
\definecolor{ecru}{rgb}{1,.98823529411764705,.95686274509803921568}

\usepackage[figure]{hypcap} % Links auf Gleitumgebungen springen nicht
                            % zur Beschriftung, sondern zum Anfang der
                            % Gleitumgebung 

\usepackage{minted}
                   
                   
                   
% 3-spaltiger Index
\makeatletter
\renewenvironment{theindex}{%
  \begin{multicols}{3}[\section*{\indexname}][19\baselineskip]%
    \setlength{\parindent}{0pt}\pagestyle{plain}\let\item\@idxitem}
  {\end{multicols}}
\makeatother

% Zweispaltige Fußnoten
\usepackage{dblfnote}
% Keine hochgestellten Ziffern in der Fußnote (KOMA-Script-spezifisch):
\deffootnote[1.5em]{0pt}{1em}{\makebox[1.5em][l]{\bfseries\thefootnotemark}} 
% Abstand zwischen Fußnoten vergrößern:
\setlength{\footnotesep}{.85\baselineskip}

\renewcommand{\footnoterule}{}             % Keine Trennlinie zur Fußnote 
\addtolength{\skip\footins}{\baselineskip} % Abstand Text <-> Fußnote
% Fußnoten immer ganz unten auf einer \raggedbottom-Seite
\usepackage{fnpos}

\raggedbottom     % Variable Seitenhöhen zulassen



%% Bibliographiestil %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\usepackage{natbib}

\newcommand{\todo}{\colorbox{yellow}{TODO} }


\newcommand{\doublepic}[4]{%

\begin{figure}[htbp]
	\begin{minipage}[b]{0.5\linewidth}
		\includegraphics[width=.95\linewidth]{pics/#1}
		\caption{#2}
		\label{fig:#1}
	\end{minipage}
	\begin{minipage}[b]{0.5\linewidth}
		\centering
		\vfill
		\includegraphics[width=.95\linewidth]{pics/#3}
		\vfill
		\caption{#4}
		\label{fig:#3}
	\end{minipage}
\end{figure}
}




\colorlet{tableheader}{Bittersweet}
\colorlet{tableline}{YellowOrange}

\font\teng=teng10

\addtokomafont{caption}{\itshape}
\addtokomafont{captionlabel}{\itshape}

\begin{document}
%% Dateiendungen für Grafiken %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ==> Sie können hiermit die Dateiendung einer Grafik weglassen.
%% ==> Aus "\includegraphics{titel.eps}" wird "\includegraphics{titel}".
%% ==> Wenn Sie nunmehr 2 inhaltsgleiche Grafiken "titel.eps" und
%% ==> "titel.pdf" erstellen, wird jeweils nur die Grafik eingebunden,
%% ==> die von ihrem Compiler verarbeitEine integrale Analyse der politischen 
%% ==> pdfLaTeX benutzt "titel.pdf". LaTeX benutzt "titel.eps".
\ifpdf
	\DeclareGraphicsExtensions{.pdf,.jpg,.png}
\else
	\DeclareGraphicsExtensions{.eps}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\includegraphics[wid%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Ihr Buch                                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Schmutztitel-Seite %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\extratitle{Schmutztitel}

%% eigene Titelseitengestaltung %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
\begin{titlepage}
%Einsetzen der TXC Vorlage "Deckblatt" möglich

\rule{\textwidth}{0pt}


\vspace{6\baselineskip}

%\begin{center}
%\includegraphics[width=0.4\textwidth]{pics/Amatsu_Ryoho_Flower_Final_Doc}
%\begin{minipage}[b]{0.3\linewidth}
%		\includegraphics[width=.95\linewidth]{pics/Amatsu_Integral.png}
%	\end{minipage}
%\end{center}

\vspace{7\baselineskip}

\begin{flushright}

\Huge\textsc{\textit{A List of Haskell Articles on good design, good testing}}

\rule{\textwidth}{4pt}

% \Large \amrint

\large William Yao

\large Matt Parsons

\large David Luposchainsky

\large Alexis King

\large Japer Van der Jeugt

\large Tom Ellis

\large Michael Snoyman

\large Sandy Maguire

\large Oskar Wickström

\large Scott Wlaschin

\large Hillel Wayne

\end{flushright}

\vfill


\tiny \copyright{} by above mentioned authors, compilation by M. Oswald. You may freely copy and distribute this document.

\texttt{\input{git_hash.tex}}

\end{titlepage}

%% Angaben zur Standardformatierung des Titels %%%%%%%%%%%%%%%%%%%%%%%%
%\titlehead{Titelkopf}
%\subject{Typisierung}
%\title{Der Name Ihrer Arbeit}
%\author{Ihr Name}
%\and{Der Name des Co-Autoren}
%\thanks{Fußnote}			% entspr. \footnote im Fließtext
%\date{}							% falls anderes, als das aktuelle gewünscht
%\publishers{Herausgeber}

%% Rückseite der Titelseite %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\uppertitleback{Titelrückseitenkopf}
%\lowertitleback{Titelrückseitenfuß}

%% Widmungsseite %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\dedication{Widmung}

%\maketitle 						% Titelei wird erzeugt

%% Erzeugung von Verzeichnissen %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
{\sffamily
\noindent This document is a compilation of web articles about Haskell, which was put together by William Yao. I was interested to have this in one document and not spread via different web pages, so I compiled them together in this document. 

\vfill

\begin{flushleft}
The homepage for this document is: 
\url{https://github.com/oswald2/haskell_articles}
\end{flushleft}
}

\newpage


\tableofcontents			% Inhaltsverzeichnis
\listoffigures				% Abbildungsverzeichnis
\listoftables				% Tabellenverzeichnis


%% Der Text %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Introduction by William Yao}

For a language that's beloved for its ability to guide the structure of programs into being easier to understand, easier to maintain, and easier to get correct, there's not a lot of resources on how to best use the tools that Haskell provides. Lots of terms and buzzwords, not a lot of in-depth practical guidance on best practices. So I've put together a list of community blog posts and articles on the theme of \emph{building more correct programs}.

These are split roughly in two groups: posts about how best to leverage the type system to eliminate errors before they even occur, while striking a balance between type complexity and usability; and posts about using Haskell's best-in-class testing facilities to shore up what can't be typed\footnote{Or at least, not typed easily}. Despite the hype around Haskell's type system, it's unlikely in a program of any complexity that you'll be able to completely eliminate the possibility of bugs and errors purely through the type system alone. Using both types \emph{and} tests gives you a better power-to-weight ratio for building maintainable, bug-free programs than either does alone.

Note that I'm explicitly not including articles and resources about basics or setup of the topics in question. Instead of ``what is a \texttt{Maybe} and why use it,'' think ``what are some typical patterns around using \texttt{Maybes} in a real codebase.'' Instead of ``what is property-based testing'', think ``here are best practices around choosing properties to test.'' Since there are already plenty of good introductory resources on things like ``how do I get started with QuickCheck'', we'll focus here instead on how best to use the tools we have.

Posts in each section are roughly ordered by difficulty.


\part{Posts on designing and structuring code}

\input{matt_parsons.tex}


\input{david_luposchainsky.tex}


\input{alexis_king.tex}


\input {jasper_van_der_jeugt.tex}


\input {tom_ellis.tex}

\input{michael_snoyman.tex}


\input{matt_parsons2.tex}


\input{sandy_maguire.tex}



\part{Posts on testing}


\input {jasper_van_der_jeugt2.tex}


\input{oskar_wickstrom.tex}



\chapter{Choosing properties for property-based testing - Scott Wlaschin}
\label{sec:choosing_properties_for_testing}

\begin{quotation}
\noindent\textit{\textbf{William Yao:}}
\textit{More starting points for figuring out what properties to test.}

\vspace{\baselineskip}
\noindent\textit{Original article: \cite{choosing_properties}}
\end{quotation}

\noindent\textit{UPDATE: I did a talk on property-based testing based on these posts. \href{https://fsharpforfunandprofit.com/pbt/}{Slides and video here}.}

\vspace{\baselineskip}

\noindent In the \href{https://fsharpforfunandprofit.com/posts/property-based-testing/}{previous post}, I described the basics of property-based testing, and showed how it could save a lot of time by generating random tests.

But here's a common problem. Everyone who sees a property-based testing tool like FsCheck or QuickCheck thinks that it is amazing\ldots but when it times come to start creating your own properties, the universal complaint is: ``what properties should I use? I can't think of any!''

The goal of this post is to show some common patterns that can help you discover the properties that are applicable to your code.

\section{Categories for properties}


In my experience, many properties can be discovered by using one of the seven approaches listed below.

\begin{itemize}
\item ``Different paths, same destination'' (see \ref{sec:different_paths_same_destination})
\item ``There and back again'' (see \ref{sec:there_and_back_again})
\item ``Some things never change'' (see \ref{sec:some_things_never_change})
\item ``The more things change, the more they stay the same'' (see \ref{sec:the_more_things_change})
\item ``Solve a smaller problem first'' (see \ref{sec:solve_a_smaller_problem_first})
\item ``Hard to prove, easy to verify'' (see \ref{sec:hard_to_prove})
\item ``The test oracle'' (see \ref{sec:the_test_oracle})
\end{itemize}
This is by no means a comprehensive list, just the ones that have been most useful to me. For a different perspective, check out the list of patterns that the PEX team at Microsoft have compiled.

\subsection{``Different paths, same destination''}
\label{sec:different_paths_same_destination}

These kinds of properties are based on combining operations in different orders, but getting the same result. For example, in the diagram below, doing $X$ then $Y$ gives the same result as doing $Y$ followed by $X$ (see figure \ref{fig:choosing_properties_1}).
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_1.png}
 \caption{Commutative Properties}
 \label{fig:choosing_properties_1}
\end{figure}
The commutative property of addition is an obvious example of this pattern. For example, the result of add 1 then add 2 is the same as the result of add 2 followed by add 1.

This pattern, generalized, can produce a wide range of useful properties. We'll see some more uses of this pattern later in this post.


\subsection{``There and back again''}
\label{sec:there_and_back_again}

These kinds of properties are based on combining an operation with its inverse, ending up with the same value you started with.

In the diagram below, doing $X$ serializes ABC to some kind of binary format, and the inverse of $X$ is some sort of deserialization that returns the same ABC value again (see figure \ref{fig:choosing_properties_2}).
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_2.png}
 \caption{Inverse Properties}
 \label{fig:choosing_properties_2}
\end{figure}
In addition to serialization/deserialization, other pairs of operations can be checked this way: \texttt{addition}/\texttt{subtraction}, \texttt{write}/\texttt{read}, \texttt{setProperty}/\texttt{getProperty}, and so on.

Other pair of functions fit this pattern too, even though they are not strict inverses, pairs such as \texttt{insert}/\texttt{contains}, \texttt{create}/\texttt{exists} , etc.



\subsection{``Some things never change''}
\label{sec:some_things_never_change}

These kinds of properties are based on an invariant that is preserved after some transformation.

In the diagram below (figure \ref{fig:choosing_properties_3}), the transform changes the order of the items, but the same four items are still present afterwards.
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_3.png}
 \caption{Invariant Properties}
 \label{fig:choosing_properties_3}
\end{figure}
Common invariants include size of a collection (for \texttt{map} say), the contents of a collection (for sort say), the height or depth of something in proportion to size (e.g. balanced trees).

\subsection{``The more things change, the more they stay the same''}
\label{sec:the_more_things_change}

These kinds of properties are based on ``idempotence'' -- that is, doing an operation twice is the same as doing it once.

In the diagram below (figure \ref{fig:choosing_properties_4}), using distinct to filter the set returns two items, but doing distinct twice returns the same set again.
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_4.png}
 \caption{Idempotent Properties}
 \label{fig:choosing_properties_4}
\end{figure}
Idempotence properties are very useful, and can be extended to things like database updates and message processing.



\subsection{``Solve a smaller problem first''}
\label{sec:solve_a_smaller_problem_first}

These kinds of properties are based on ``structural induction'' -- that is, if a large thing can be broken into smaller parts, and some property is true for these smaller parts, then you can often prove that the property is true for a large thing as well.

In the diagram below (figure \ref{fig:choosing_properties_5}), we can see that the four-item list can be partitioned into an item plus a three-item list, which in turn can be partitioned into an item plus a two-item list. If we can prove the property holds for two-item list, then we can infer that it holds for the three-item list, and for the four-item list as well.
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_5.png}
 \caption{Induction Properties}
 \label{fig:choosing_properties_5}
\end{figure}
Induction properties are often naturally applicable to recursive structures such as lists and trees.



\subsection{``Hard to prove, easy to verify''}
\label{sec:hard_to_prove}

Often an algorithm to find a result can be complicated, but verifying the answer is easy.

In the diagram below (figure \ref{fig:choosing_properties_6}), we can see that finding a route through a maze is hard, but checking that it works is trivial!
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_6.png}
 \caption{Easy to Verify Properties}
 \label{fig:choosing_properties_6}
\end{figure}
Many famous problems are of this sort, such as prime number factorization. But this approach can be used for even simple problems.

For example, you might check that a string tokenizer works by just concatenating all the tokens again. The resulting string should be the same as what you started with.

\subsection{``The test oracle''}
\label{sec:the_test_oracle}

In many situations you often have an alternate version of an algorithm or process (a ``test oracle'') that you can use to check your results (figure \ref{fig:choosing_properties_7}).
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_7.png}
 \caption{Test Oracle}
 \label{fig:choosing_properties_7}
\end{figure}
For example, you might have a high-performance algorithm with optimization tweaks that you want to test. In this case, you might compare it with a brute force algorithm that is much slower but is also much easier to write correctly.

Similarly, you might compare the result of a parallel or concurrent algorithm with the result of a linear, single thread version.


\section{Putting the categories to work with some real examples}


In this section, we'll apply these categories to see if we can come up with properties for some simple functions such as ``sort a list'' and ``reverse a list''.

\subsection{``Different paths, same destination'' applied to a list sort}


Let's start with ``different paths, same destination'' and apply it to a ``list sort'' function.

Can we think of any way of combining an operation \textit{before} \texttt{List.sort}, and another operation \textit{after} \texttt{List.sort}, so that you should end up with the same result? That is, so that ``going up then across the top'' is the same as ``going across the bottom then up''.
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_8.png}
 \caption{List Sort Property}
 \label{fig:choosing_properties_8}
\end{figure}
How about this?

\begin{itemize}
\item \textbf{Path 1}: We add one to each element of the list, then sort.
\item \textbf{Path 2}: We sort, then add one to each element of the list.
\item Both lists should be equal.
\end{itemize}
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_9.png}
 \caption{List Sort Property +1}
 \label{fig:choosing_properties_9}
\end{figure}
Here's some code that implements that property:

\begin{minted}{fsharp}
let ``+1 then sort should be same as sort then +1`` sortFn aList = 
    let add1 x = x + 1
    
    let result1 = aList |> sortFn |> List.map add1
    let result2 = aList |> List.map add1 |> sortFn 
    result1 = result2

// test 
let goodSort = List.sort
Check.Quick (``+1 then sort should be same as sort then +1`` goodSort)
// Ok, passed 100 tests.
\end{minted}
Well, that works, but it also would work for a lot of other transformations too. For example, if we implemented \texttt{List.sort} as just the identity, then this property would be satisfied equally well! You can test this for yourself:

\begin{minted}{fsharp}
let badSort aList = aList
Check.Quick (``+1 then sort should be same as sort then +1`` badSort)
// Ok, passed 100 tests.
\end{minted}
The problem with this property is that it is not exploiting any of the ''sortedness``. We know that a sort will probably reorder a list, and certainly, the smallest element should be first.

How about adding an item that we know will come at the front of the list after sorting?

\begin{itemize}
\item \textbf{Path 1}: We append Int32.MinValue to the end of the list, then sort.
\item \textbf{Path 2}: We sort, then prepend Int32.MinValue to the front of the list.
\item Both lists should be equal.
\end{itemize}
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_10.png}
 \caption{List Sort Property with \texttt{Int32.MinValue}}
 \label{fig:choosing_properties_10}
\end{figure}
Here's the code:

\begin{minted}{fsharp}
let ``append minValue then sort should be same as sort then prepend minValue`` 
    sortFn aList = 
        let minValue = Int32.MinValue

        let appendThenSort = (aList @ [minValue]) |> sortFn 
        let sortThenPrepend = minValue :: (aList |> sortFn)
        appendThenSort = sortThenPrepend 

// test
Check.Quick (``append minValue then sort should be same as sort then 
    prepend minValue`` goodSort)
// Ok, passed 100 tests.
\end{minted}
The bad implementation fails now!

\begin{minted}{fsharp}
Check.Quick (``append minValue then sort should be same as sort then 
    prepend minValue`` badSort)
// Falsifiable, after 1 test (2 shrinks) 
// [0]
\end{minted}
In other words, the bad sort of \texttt{[0; minValue]} is \textit{not} the same as \texttt{[minValue; 0]}.
So that's good!

But\ldots we've got some hard coded things in there that the Enterprise Developer From Hell (\href{https://fsharpforfunandprofit.com/posts/property-based-testing/}{see previous post}) could take advantage of! The EDFH will exploit the fact that we always use \texttt{Int32.MinValue} and that we always prepend or append it to the test list.

In other words, the EDFH can identify which path we are on and have special cases for each one:

\begin{minted}{fsharp}
// The Enterprise Developer From Hell strikes again
let badSort2 aList = 
	match aList with
	| [] -> []
	| _ -> 
		let last::reversedTail = List.rev aList 
		if (last = Int32.MinValue) then
			// if min is last, move to front
			let unreversedTail = List.rev reversedTail
			last :: unreversedTail 
		else
			aList // leave alone
\end{minted}
And when we check it\ldots

\begin{minted}{fsharp}
// Oh dear, the bad implementation passes!
Check.Quick (``append minValue then sort should be same as sort then 
    prepend minValue`` badSort2)
// Ok, passed 100 tests.
\end{minted}
We could fix this by (a) picking a random number smaller than any number in the list and (b) inserting it at a random location rather than always appending it. But rather than getting too complicated, let's stop and reconsider.

An alternative approach which also exploits the ''sortedness`` is to first negate all the values, then on the path that negates \textit{after} the sort, add an extra reverse as well.
\begin{figure}[htbp]
 \centering
 \includegraphics[width=.95\linewidth]{./pics/choosing_properties_11.png}
 \caption{List Sort Property with negate}
 \label{fig:choosing_properties_11}
\end{figure}
\begin{minted}{fsharp}
let ``negate then sort should be same as sort then negate then reverse`` 
    sortFn aList = 
        let negate x = x * -1

        let negateThenSort = aList |> List.map negate |> sortFn 
        let sortThenNegateAndReverse = aList |> sortFn |> List.map 
                negate |> List.rev
        negateThenSort = sortThenNegateAndReverse 
\end{minted}
This property is harder for the EDFH to beat because there are no magic numbers to help identify which path you are on:

\begin{minted}{fsharp}
// test
Check.Quick ( ``negate then sort should be same as sort then negate then 
    reverse`` goodSort)
// Ok, passed 100 tests.

// test
Check.Quick ( ``negate then sort should be same as sort then negate then 
    reverse``  badSort)
// Falsifiable, after 1 test (1 shrinks) 
// [1; 0]

// test
Check.Quick ( ``negate then sort should be same as sort then negate then 
    reverse``  badSort2)
// Falsifiable, after 5 tests (3 shrinks) 
// [1; 0]
\end{minted}
You might argue that we are only testing sorting for lists of integers. But the \texttt{List.sort} function is generic and knows nothing about integers per se, so I have high confidence that this property does test the core sorting logic.







\chapter{Finding Property Tests - Hillel Wayne}
\label{sec:finding_property_tests}


\appendix							% Beginn des Anhangs


%% Bibliographie unter Verwendung von dinnat %%%%%%%%%%%%%%%%%%%%%%%%%%
%\setbibpreamble{Präambel}		% Text vor dem Verzeichnis
\bibliographystyle{plain}
\bibliography{HaskellArticles}	% Sie benötigen einen *.bib-Datei



\end{document}
